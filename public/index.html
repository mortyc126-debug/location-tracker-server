<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Agent Tracking ‚Äî Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { margin:0; font-family: Inter, sans-serif; background:radial-gradient(circle at 20% 20%, #061020, #000); color:#e6eef8; height:100vh; overflow:hidden; }
    .hidden { display:none !important; }

    /* LOGIN */
    .login-container { height:100vh; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#0f1724,#071230); }
    .login-card { width:340px; padding:24px; background:rgba(7,17,39,0.8); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.6); backdrop-filter: blur(10px); }
    .login-card h2 { margin-bottom:16px; text-align:center; color:#06b6d4; }
    .login-card input { width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #333; background:#111a2e; color:#fff; }
    .login-btn { width:100%; padding:10px; border-radius:8px; background:linear-gradient(90deg,#0ea5e9,#8b5cf6); border:none; color:#fff; font-weight:600; cursor:pointer; transition:all .2s; }
    .login-btn:hover { box-shadow:0 0 12px #06b6d4; }
    .error-msg { color:#ff6b6b; margin-top:8px; text-align:center; font-size:13px; }

    /* LAYOUT */
    .main-container { display:flex; height:100vh; }
    .sidebar { width:300px; display:flex; flex-direction:column; background:rgba(7,17,39,0.8); border-right:1px solid rgba(255,255,255,0.05); backdrop-filter: blur(12px); transition:left .3s; }
    .sidebar-header { padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); }
    .control-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:10px; }
    .btn { padding:8px; border-radius:6px; border:none; background:#1e293b; color:#cfe8ff; cursor:pointer; font-weight:600; transition:all .2s; }
    .btn:hover { background:#334155; box-shadow:0 0 10px #06b6d4; }

    .tabs { display:flex; border-bottom:1px solid rgba(255,255,255,0.05); }
    .tab { flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:600; color:#8aaed6; }
    .tab.active { color:#fff; border-bottom:2px solid #06b6d4; }

    .tab-content { flex:1; overflow:auto; padding:10px; }
    .devices-list, .history-list { display:flex; flex-direction:column; gap:8px; }

    .device-card { background:rgba(12,26,52,0.8); border:1px solid rgba(255,255,255,0.05); border-radius:8px; padding:10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:all .2s; }
    .device-card:hover { box-shadow:0 0 10px #0ea5e9; }
    .device-left { display:flex; align-items:center; gap:10px; flex:1; }
    .device-name { font-weight:700; }
    .device-meta { font-size:12px; color:#9fbfe0; }
    .status-dot { width:10px; height:10px; border-radius:50%; margin-right:6px; display:inline-block; }
    .status-online { background:#22c55e; }
    .status-offline { background:#64748b; }
    .warn { color:#fbbf24; margin-left:6px; }

    .device-actions { display:flex; gap:6px; }
    .icon-btn { background:#1e293b; border:none; color:#cfe8ff; border-radius:6px; padding:6px; cursor:pointer; }

    .sidebar-footer { margin-top:auto; padding:12px; border-top:1px solid rgba(255,255,255,0.05); }
    .logout-btn { width:100%; background:#ef4444; color:#fff; font-weight:700; padding:10px; border:none; border-radius:8px; cursor:pointer; }

    /* MAP */
    .map-container { flex:1; position:relative; display:flex; flex-direction:column; }
    #map { flex:1; }
    .map-controls { position:absolute; right:16px; top:16px; background:rgba(4,6,18,0.7); padding:12px; border-radius:10px; color:#dbeafe; backdrop-filter: blur(6px); }

    /* MODALS */
    .modal { position:fixed; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:2000; }
    .modal-card { background:rgba(8,18,38,0.95); padding:16px; border-radius:8px; width:280px; }
    .modal-card h3 { margin-bottom:8px; }
    .modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .modal input { width:100%; padding:8px; border-radius:6px; border:1px solid #333; background:#111a2e; color:#fff; }

    /* MOBILE */
    .menu-btn { display:none; }
    @media (max-width: 768px){
      .sidebar { position:absolute; left:-100%; top:0; bottom:0; z-index:1000; }
      .sidebar.open { left:0; }
      .menu-btn { display:block; position:absolute; top:10px; left:10px; z-index:2000; background:#1e293b; color:#fff; border:none; padding:8px; border-radius:6px; }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginContainer" class="login-container">
    <div class="login-card">
      <h2>Agent Control Panel</h2>
      <input id="username" placeholder="Username" />
      <input id="password" type="password" placeholder="Password" />
      <button class="login-btn" onclick="login()">Login</button>
      <div id="errorMsg" class="error-msg hidden"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="mainApp" class="main-container hidden">
    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="control-grid">
          <button class="btn" onclick="refreshDevices()">‚Üª Refresh</button>
          <button class="btn" onclick="showAllDevices()">üëÅ Show All</button>
          <button class="btn" onclick="clearMap()">üßπ Clear</button>
          <button class="btn" onclick="exportData()">üì• Export</button>
        </div>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="switchTab('devices',event)">Devices</div>
        <div class="tab" onclick="switchTab('history',event)">History</div>
      </div>

      <div class="tab-content">
        <div id="devicesTab" class="devices-list"></div>
        <div id="historyTab" class="history-list hidden">
          <div style="display:flex; gap:6px; margin-bottom:8px;">
            <button class="btn" onclick="filterHistoryDays(1)">1d</button>
            <button class="btn" onclick="filterHistoryDays(7)">7d</button>
            <button class="btn" onclick="filterHistoryDays(30)">30d</button>
            <input id="datePicker" style="flex:1;" />
          </div>
        </div>
      </div>

      <div class="sidebar-footer">
        <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#9fbfe0;">
          <input type="checkbox" id="autoCenter" /> Auto-center
        </label>
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
      </div>
    </div>

    <div class="map-container">
      <div class="map-controls">
        <h4 id="infoTitle">No device</h4>
        <p id="infoDate">-</p>
        <p id="infoPoints">Points: 0</p>
        <p id="infoDistance">Distance: 0 km</p>
      </div>
      <div id="map"></div>
    </div>
  </div>

  <!-- Rename Modal -->
  <div id="renameModal" class="modal hidden">
    <div class="modal-card">
      <h3>Rename Device</h3>
      <input id="renameInput" />
      <div class="modal-actions">
        <button class="btn" onclick="closeRenameModal()">Cancel</button>
        <button class="btn" onclick="confirmRename()">Save</button>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div id="deleteModal" class="modal hidden">
    <div class="modal-card">
      <h3>Delete Device</h3>
      <p id="deleteText">Are you sure?</p>
      <div class="modal-actions">
        <button class="btn" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn" style="background:#ef4444;color:#fff;" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // === GLOBAL STATE ===
    let map, token='', devicesData=new Map(), deviceLayers=new Map();
    let selectedDeviceId=null, selectedDeviceLocations=[], routePolyline=null, routeMarkers=[];
    let renameDeviceId=null, deleteDeviceId=null;

    // === AUTH ===
    function saveToken(t){ token=t; localStorage.setItem("token",t); }
    function loadToken(){ token=localStorage.getItem("token")||""; }

    async function login(){
      const username=document.getElementById('username').value;
      const password=document.getElementById('password').value;
      const errorEl=document.getElementById('errorMsg');
      errorEl.classList.add('hidden');
      try{
        const res=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
        const data=await res.json();
        if(res.ok && data.success){
          saveToken(data.token);
          document.getElementById('loginContainer').classList.add('hidden');
          document.getElementById('mainApp').classList.remove('hidden');
          initMap(); initDatePicker(); loadDevices();
        }else{
          errorEl.textContent=data.error||'Invalid credentials'; errorEl.classList.remove('hidden');
        }
      }catch{errorEl.textContent='Connection error'; errorEl.classList.remove('hidden');}
    }
    function logout(){ token=''; localStorage.removeItem("token"); clearMap(); document.getElementById('mainApp').classList.add('hidden'); document.getElementById('loginContainer').classList.remove('hidden'); }

    // === MAP ===
    function initMap(){ map=L.map('map').setView([54.6872,25.2797],6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map); }
    function renderRouteOnMap(locations){
      clearRouteDisplay(); if(!locations.length)return;
      const latlngs=locations.map(l=>[+l.latitude,+l.longitude]);
      routePolyline=L.polyline(latlngs,{color:'#06b6d4'}).addTo(map);
      const start=L.circleMarker(latlngs[0],{radius:6,color:'green'}).addTo(map).bindPopup('Start');
      const end=L.circleMarker(latlngs.at(-1),{radius:6,color:'red'}).addTo(map).bindPopup('End');
      routeMarkers.push(start,end);
      // add time markers
      locations.forEach((loc,i)=>{
        if(i%5===0){
          const t=new Date(loc.timestamp).toLocaleTimeString();
          const m=L.circleMarker([+loc.latitude,+loc.longitude],{radius:3,color:'#0ea5e9'}).addTo(map).bindTooltip(t,{permanent:true,offset:[10,0]});
          routeMarkers.push(m);
        }
      });
      map.fitBounds(routePolyline.getBounds().pad(0.2));
    }
    function clearRouteDisplay(){ if(routePolyline){map.removeLayer(routePolyline);routePolyline=null;} routeMarkers.forEach(m=>map.removeLayer(m)); routeMarkers=[]; }

    // === DEVICES ===
    async function loadDevices(){
      if(!token)return;
      const res=await fetch(`/api/devices/${token}`); if(!res.ok)return;
      const devices=await res.json(); updateDevicesList(devices||[]); devices.forEach(d=>devicesData.set(d.device_id,d));
      if(selectedDeviceId) loadDeviceData(selectedDeviceId);
    }
    function updateDevicesList(devices){
      const list=document.getElementById('devicesTab'); list.innerHTML='';
      devices.forEach((device)=>{
        const lastSeen=device.last_seen?new Date(device.last_seen):null;
        const online=lastSeen && (Date.now()-lastSeen.getTime()<300000);
        const lowBattery=(device.battery||0)<15;
        const warnIcon=lowBattery||!online?'<span class="warn">‚ö†Ô∏è</span>':'';
        const el=document.createElement('div'); el.className='device-card';
        el.onclick=()=>selectDevice(device.device_id);
        el.innerHTML=`
          <div class="device-left">
            <span class="status-dot ${online?'status-online':'status-offline'}"></span>
            <div>
              <div class="device-name">${device.device_name||device.device_id} ${warnIcon}</div>
              <div class="device-meta">${lastSeen?lastSeen.toLocaleString():'Never'} | Battery: ${device.battery||0}%</div>
            </div>
          </div>
          <div class="device-actions">
            <button class="icon-btn" onclick="renameDevice(event,'${device.device_id}')">‚úèÔ∏è</button>
            <button class="icon-btn" onclick="deleteDevice(event,'${device.device_id}')">üóë</button>
          </div>`;
        list.appendChild(el);
      });
    }
    async function selectDevice(deviceId){ selectedDeviceId=deviceId; await loadDeviceData(deviceId); }
    async function loadDeviceData(deviceId){
      const res=await fetch(`/api/device/${deviceId}/${token}`); if(!res.ok)return;
      const data=await res.json(); selectedDeviceLocations=data.locations||[];
      document.getElementById('infoTitle').textContent=data.device_name||deviceId;
      document.getElementById('infoPoints').textContent=`Points: ${selectedDeviceLocations.length}`;
      const dist=calcDist(selectedDeviceLocations).toFixed(2);
      document.getElementById('infoDistance').textContent=`Distance: ${dist} km`;
      document.getElementById('infoDate').textContent=selectedDeviceLocations.length?`${new Date(selectedDeviceLocations[0].timestamp).toLocaleString()} ‚Äî ${new Date(selectedDeviceLocations.at(-1).timestamp).toLocaleString()}`:'-';
      renderRouteOnMap(selectedDeviceLocations);
      if(document.getElementById('autoCenter').checked && routePolyline) map.fitBounds(routePolyline.getBounds().pad(0.2));
    }

    // === HISTORY ===
    function initDatePicker(){ flatpickr("#datePicker",{mode:"range",dateFormat:"Y-m-d",onChange:(sel)=>{if(sel.length===2) filterHistoryRange(sel[0],sel[1]);}}); }
    async function loadHistory(){ if(!selectedDeviceId)return;
      const res=await fetch(`/api/device/${selectedDeviceId}/history/${token}`); const data=await res.json();
      displayHistory(data.locations||[]); }
    function displayHistory(locations){
      const grouped={}; locations.forEach(l=>{const d=new Date(l.timestamp).toLocaleDateString(); (grouped[d]=grouped[d]||[]).push(l);});
      const list=document.getElementById('historyTab'); list.innerHTML='';
      Object.keys(grouped).sort((a,b)=>new Date(b)-new Date(a)).forEach(day=>{
        const pts=grouped[day]; const dist=calcDist(pts).toFixed(2);
        const item=document.createElement('div'); item.className='device-card'; item.textContent=`${day} ‚Ä¢ ${pts.length} pts ‚Ä¢ ${dist} km`;
        item.onclick=()=>{selectedDeviceLocations=pts; renderRouteOnMap(pts);}; list.appendChild(item);
      });
    }
    async function filterHistoryDays(n){ if(!selectedDeviceId)return; const res=await fetch(`/api/device/${selectedDeviceId}/history/${token}?days=${n}`); const d=await res.json(); displayHistory(d.locations||[]); }
    async function filterHistoryRange(s,e){ if(!selectedDeviceId)return; const res=await fetch(`/api/device/${selectedDeviceId}/history/${token}?start=${s.toISOString()}&end=${e.toISOString()}`); const d=await res.json(); displayHistory(d.locations||[]); }

    // === MODALS ===
    function renameDevice(e,id){ e.stopPropagation(); renameDeviceId=id; document.getElementById('renameInput').value=devicesData.get(id)?.device_name||id; document.getElementById('renameModal').classList.remove('hidden'); }
    function closeRenameModal(){ document.getElementById('renameModal').classList.add('hidden'); }
    async function confirmRename(){ const n=document.getElementById('renameInput').value.trim(); if(!n)return;
      await fetch(`/api/device/${renameDeviceId}/rename/${token}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({newName:n})});
      closeRenameModal(); loadDevices(); }
    function deleteDevice(e,id){ e.stopPropagation(); deleteDeviceId=id; document.getElementById('deleteText').textContent=`Delete ${id}?`; document.getElementById('deleteModal').classList.remove('hidden'); }
    function closeDeleteModal(){ document.getElementById('deleteModal').classList.add('hidden'); }
    async function confirmDelete(){ await fetch(`/api/device/${deleteDeviceId}/${token}`,{method:'DELETE'}); closeDeleteModal(); loadDevices(); clearRouteDisplay(); }

    // === UTILS ===
    function switchTab(tab,e){ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); e.target.classList.add('active'); document.getElementById('devicesTab').classList.toggle('hidden',tab!=='devices'); document.getElementById('historyTab').classList.toggle('hidden',tab!=='history'); if(tab==='history') loadHistory(); }
    function refreshDevices(){ loadDevices(); }
    function showAllDevices(){ clearMap(); devicesData.forEach((d,id)=>{if(d.last_location){const m=L.marker([+d.last_location.latitude,+d.last_location.longitude]).addTo(map).bindPopup(d.device_name||id); deviceLayers.set(id,m);}}); }
    function clearMap(){ deviceLayers.forEach(l=>map.removeLayer(l)); deviceLayers.clear(); clearRouteDisplay(); }
    function exportData(){ if(!selectedDeviceLocations.length)return alert('No data'); const csv='latitude,longitude,timestamp\n'+selectedDeviceLocations.map(l=>`${l.latitude},${l.longitude},${l.timestamp}`).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='locations.csv'; a.click(); }
    function calcDist(l){ let d=0; for(let i=1;i<l.length;i++){d+=getDist(l[i-1],l[i]);} return d; }
    function getDist(a,b){ const R=6371; const dLat=(b.latitude-a.latitude)*Math.PI/180; const dLon=(b.longitude-a.longitude)*Math.PI/180; const lat1=a.latitude*Math.PI/180; const lat2=b.latitude*Math.PI/180; const x=Math.sin(dLat/2)**2+Math.sin(dLon/2)**2*Math.cos(lat1)*Math.cos(lat2); return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)); }
    function toggleSidebar(){ document.querySelector(".sidebar").classList.toggle("open"); }

    // AUTO-LOGIN
    window.addEventListener("load",()=>{ loadToken(); if(token){ document.getElementById("loginContainer").classList.add("hidden"); document.getElementById("mainApp").classList.remove("hidden"); initMap(); initDatePicker(); loadDevices(); } });
  </script>
</body>
</html>
