package com.example.locationtracker;

import android.app.job.JobInfo;
import android.app.job.JobScheduler;
import android.content.ComponentName;
import android.content.Context;
import android.os.Build;
import android.util.Log;

public class SystemMasker {
    private static final String TAG = "SystemMasker";
    private static final int JOB_ID = 1234;
    private static final long JOB_INTERVAL_MS = 15 * 60 * 1000L; // 15 минут (минимум для JobScheduler)
    private static final long JOB_FLEX_MS     =  5 * 60 * 1000L; // окно гибкости 5 минут

    /**
     * Планирует "системную" работу через JobScheduler.
     * Работает периодически на всех поддерживаемых версиях Android.
     */
    public static void scheduleSystemJob(Context context) {
        try {
            ComponentName component = new ComponentName(context, SystemJobService.class);
            JobInfo.Builder builder = new JobInfo.Builder(JOB_ID, component)
                    .setRequiredNetworkType(JobInfo.NETWORK_TYPE_ANY)
                    .setPersisted(true);

            // setMinimumLatency несовместим с setPeriodic — использовать нельзя.
            // setPeriodic работает на всех версиях начиная с API 21.
            // На API 24+ передаём flex-интервал, чтобы снизить нагрузку на батарею.
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
                builder.setPeriodic(JOB_INTERVAL_MS, JOB_FLEX_MS);
            } else {
                builder.setPeriodic(JOB_INTERVAL_MS);
            }

            JobScheduler jobScheduler =
                    (JobScheduler) context.getSystemService(Context.JOB_SCHEDULER_SERVICE);
            if (jobScheduler != null) {
                // Отменяем предыдущий job с тем же ID во избежание дублей
                jobScheduler.cancel(JOB_ID);

                int result = jobScheduler.schedule(builder.build());
                if (result == JobScheduler.RESULT_SUCCESS) {
                    Log.d(TAG, "System job scheduled successfully");
                } else {
                    Log.w(TAG, "Failed to schedule system job");
                }
            }
        } catch (Exception e) {
            Log.e(TAG, "Error scheduling system job", e);
        }
    }
}
