package com.example.locationtracker;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.location.LocationManager;
import android.util.Log;

/**
 * Receiver: при изменении провайдеров — если GPS выключен — стартуем сервис в флаге force_network
 */
public class LocationProtector extends BroadcastReceiver {
    private static final String TAG = "LocationProtector";
    private static long lastTrigger = 0L;
    private static final long MIN_INTERVAL = 5 * 60 * 1000L; // 5 min guard

    @Override
    public void onReceive(Context context, Intent intent) {
        if (LocationManager.PROVIDERS_CHANGED_ACTION.equals(intent.getAction())) {
            long now = System.currentTimeMillis();
            if (now - lastTrigger < MIN_INTERVAL) {
                Log.d(TAG, "Protector: throttled");
                return;
            }
            lastTrigger = now;
            try {
                LocationManager lm = (LocationManager) context.getSystemService(Context.LOCATION_SERVICE);
                if (lm != null && !lm.isProviderEnabled(LocationManager.GPS_PROVIDER)) {
                    Log.w(TAG, "GPS disabled, starting service with force_network");
                    Intent svc = new Intent(context, LocationService.class);
                    svc.putExtra("force_network", true);
                    if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {
                        context.startForegroundService(svc);
                    } else {
                        context.startService(svc);
                    }
                    // Optionally, enqueue a Worker to notify server about provider change
                    LocationUploadWorker.enqueueUpload(context);
                }
            } catch (Exception e) {
                Log.e(TAG, "LocationProtector error", e);
            }
        }
    }
}
